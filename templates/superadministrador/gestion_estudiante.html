{% extends 'superadministrador/base_superadmin.html' %}
{% load static %}
{% block title %}Gestión de Estudiantes - Sistema de Laboratorios{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="{% static 'css/superadministrador/gestion_estudiante.css' %}">
{% endblock %}

{% block content %}
<div class="estudiantes-container">
    <!-- Header profesional -->
    <div class="page-header">
        <h2><i class="fas fa-user-graduate"></i> Gestión de Estudiantes</h2>
        <p>Administre y organice los estudiantes del sistema</p>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
        <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="searchInput" placeholder="Buscar por nombre, curso o correo...">
            <button class="clear-search" id="clearSearch">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="actions-container">
            <button class="btn-primary" id="newStudentBtn">
                <i class="fas fa-user-plus"></i> Nuevo Estudiante
            </button>
        </div>
    </div>

    <!-- Tabla profesional -->
    <div class="table-wrapper">
        <div class="table-container">
            <table class="estudiantes-table">
                <thead>
                    <tr>
                        <th>Estudiante</th>
                        <th>Curso</th>
                        <th>Colegio</th>
                        <th>Correo</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    {% for estudiante in estudiantes %}
                    <tr>
                        <td>
                            <div class="student-info">
                                <div class="student-icon">
                                    <i class="fas fa-user-graduate"></i>
                                </div>
                                <div class="student-details">
                                    <div class="student-name">
                                        {% with persona=estudiante.persona %}
                                            {% if persona %}
                                                {{ persona.nombre }} {{ persona.apellidoPaterno }} {{ persona.apellidoMaterno }}
                                            {% else %}
                                                <span style="color:#94a3b8">Sin nombre</span>
                                            {% endif %}
                                        {% endwith %}
                                    </div>
                                    <div class="student-id">ID: {{ estudiante.id }}</div>
                                </div>
                            </div>
                        </td>
                        <td>{{ estudiante.curso }}</td>
                        <td>
                            <div class="school-cell">
                                <i class="fas fa-school"></i>
                                {{ estudiante.colegio.nombre }}
                            </div>
                        </td>
                        <td>
                            <div class="email-cell">
                                <i class="fas fa-envelope"></i>
                                {{ estudiante.persona.usuario.correo }}
                            </div>
                        </td>
                        <td>
                            <form method="POST" class="estado-form" id="form-estado-{{ estudiante.id }}">
                                {% csrf_token %}
                                <input type="hidden" name="cambiar_estado" value="1">
                                <input type="hidden" name="estudiante_id" value="{{ estudiante.id }}">
                                <label class="switch">
                                    <input type="checkbox" class="toggle-estado" 
                                           name="nuevo_estado"
                                           value="{% if estudiante.activo %}Inactivo{% else %}Activo{% endif %}"
                                           {% if estudiante.activo %}checked{% endif %}>
                                    <span class="slider round"></span>
                                </label>
                            </form>
                        </td>
                        <td>
                            <div class="acciones">
                                <button class="btn-icon btn-edit" title="Editar" onclick="openEditModal(
                                    '{{ estudiante.id }}', 
                                    '{{ estudiante.persona.usuario.correo|escapejs }}', 
                                    '{{ estudiante.colegio.id }}', 
                                    '{{ estudiante.curso|escapejs }}',
                                    '{{ estudiante.persona.nombre|escapejs }}',
                                    '{{ estudiante.persona.apellidoPaterno|escapejs }}',
                                    '{{ estudiante.persona.apellidoMaterno|escapejs }}'
                                )">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <i class="fas fa-user-graduate"></i>
                                <h3>No hay estudiantes registrados</h3>
                                <p>Haga clic en "Nuevo Estudiante" para agregar uno</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Crear Estudiante - CON 2 COLUMNAS -->
<div class="modal-overlay" id="studentModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-user-plus"></i> Nuevo Estudiante</h3>
            <button class="close-modal" id="closeModal" type="button">&times;</button>
        </div>
        <form id="studentForm" method="post" action="">
            {% csrf_token %}
            <input type="hidden" name="crear" value="1">
            <div class="modal-body">
                <div class="form-columns">
                    <!-- Columna Izquierda -->
                    <div>
                        <div class="form-group">
                            <label for="create_nombre">
                                <i class="fas fa-user"></i> Nombre
                            </label>
                            <input type="text" id="create_nombre" name="nombre" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label for="create_apellidoPaterno">
                                <i class="fas fa-user"></i> Apellido Paterno
                            </label>
                            <input type="text" id="create_apellidoPaterno" name="apellidoPaterno" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label for="create_apellidoMaterno">
                                <i class="fas fa-user"></i> Apellido Materno
                            </label>
                            <input type="text" id="create_apellidoMaterno" name="apellidoMaterno" class="form-control" required>
                        </div>
                    </div>

                    <!-- Columna Derecha -->
                    <div>
                        <div class="form-group">
                            <label for="create_correo">
                                <i class="fas fa-envelope"></i> Correo Electrónico
                            </label>
                            <input type="email" id="create_correo" name="correo" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label for="create_contrasenia">
                                <i class="fas fa-lock"></i> Contraseña
                            </label>
                            <div class="password-container">
                                <input type="password" id="create_contrasenia" name="contrasenia" class="form-control" required>
                                <button type="button" class="toggle-password" data-target="create_contrasenia">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="create_colegio">
                                <i class="fas fa-school"></i> Colegio
                            </label>
                            <select id="create_colegio" name="colegio" class="form-control" required>
                                <option value="">Seleccione un colegio...</option>
                                {% for colegio in colegios %}
                                <option value="{{ colegio.id }}">{{ colegio.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="create_curso">
                                <i class="fas fa-book"></i> Curso
                            </label>
                            <input type="text" id="create_curso" name="curso" class="form-control" required>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="cancelBtn">Cancelar</button>
                <button type="submit" class="btn-primary" id="saveBtn">
                    <i class="fas fa-save"></i> Crear Estudiante
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Editar Estudiante - COMPLETO CON NOMBRE Y APELLIDOS -->
<div class="modal-overlay" id="editModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Editar Estudiante</h3>
            <button class="close-modal" id="closeEditModal" type="button">&times;</button>
        </div>
        <form id="editStudentForm" method="post" action="">
            {% csrf_token %}
            <input type="hidden" name="editar" value="1">
            <input type="hidden" id="edit_id" name="editar_id">
            <div class="modal-body">
                <div class="form-columns">
                    <!-- Columna Izquierda -->
                    <div>
                        <div class="form-group">
                            <label for="edit_nombre">
                                <i class="fas fa-user"></i> Nombre
                            </label>
                            <input type="text" id="edit_nombre" name="editar_nombre" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label for="edit_apellidoPaterno">
                                <i class="fas fa-user"></i> Apellido Paterno
                            </label>
                            <input type="text" id="edit_apellidoPaterno" name="editar_apellidoPaterno" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label for="edit_apellidoMaterno">
                                <i class="fas fa-user"></i> Apellido Materno
                            </label>
                            <input type="text" id="edit_apellidoMaterno" name="editar_apellidoMaterno" class="form-control" required>
                        </div>
                    </div>

                    <!-- Columna Derecha -->
                    <div>
                        <div class="form-group">
                            <label for="edit_correo">
                                <i class="fas fa-envelope"></i> Correo Electrónico
                            </label>
                            <input type="email" id="edit_correo" name="editar_correo" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label for="edit_contrasenia">
                                <i class="fas fa-lock"></i> Contraseña
                            </label>
                            <div class="password-container">
                                <input type="password" id="edit_contrasenia" name="editar_contrasenia" class="form-control" 
                                       placeholder="Dejar en blanco para no cambiar">
                                <button type="button" class="toggle-password" data-target="edit_contrasenia">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="edit_colegio">
                                <i class="fas fa-school"></i> Colegio
                            </label>
                            <select id="edit_colegio" name="editar_colegio" class="form-control" required>
                                <option value="">Seleccione un colegio...</option>
                                {% for colegio in colegios %}
                                <option value="{{ colegio.id }}">{{ colegio.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="edit_curso">
                                <i class="fas fa-book"></i> Curso
                            </label>
                            <input type="text" id="edit_curso" name="editar_curso" class="form-control" required>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="cancelEditBtn">Cancelar</button>
                <button type="submit" class="btn-primary" id="updateBtn">
                    <i class="fas fa-save"></i> Actualizar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Notificación -->
<div class="custom-alert" id="customAlert">
    <div class="alert-header">
        <i class="fas fa-check-circle alert-icon" id="alertIcon"></i>
        <span id="alertTitle">Éxito</span>
        <button class="alert-close" id="alertClose">&times;</button>
    </div>
    <div class="alert-body">
        <p id="alertMessage">Operación realizada correctamente.</p>
    </div>
</div>

<script>
    // Mostrar notificaciones basadas en parámetros de URL
    window.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        
        if (urlParams.get('creado') === 'true') {
            showAlert('Estudiante creado exitosamente', 'success');
        }
        
        if (urlParams.get('editado') === 'true') {
            showAlert('Estudiante actualizado exitosamente', 'success');
        }
        
        if (urlParams.get('eliminado') === 'true') {
            showAlert('Estudiante eliminado exitosamente', 'success');
        }
        
        if (urlParams.get('error') === 'true') {
            showAlert('Ha ocurrido un error en la operación', 'error');
        }
    });

    // Modales
    const modal = document.getElementById('studentModal');
    const editModal = document.getElementById('editModal');
    const newStudentBtn = document.getElementById('newStudentBtn');
    const closeModalBtn = document.getElementById('closeModal');
    const closeEditModalBtn = document.getElementById('closeEditModal');
    const cancelBtn = document.getElementById('cancelBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const searchInput = document.getElementById('searchInput');
    const clearSearch = document.getElementById('clearSearch');
    const tableBody = document.getElementById('tableBody');
    const customAlert = document.getElementById('customAlert');
    const alertClose = document.getElementById('alertClose');

    // Función para abrir modal de crear estudiante
    function openModal() {
        modal.style.display = 'flex';
        document.getElementById('create_correo').focus();
    }

    // Función para cerrar modal de crear estudiante
    function closeModal() {
        modal.style.display = 'none';
        document.getElementById('studentForm').reset();
    }

    // Función para abrir modal de editar estudiante
    function openEditModal(id, correo, colegioId, curso, nombre, apellidoPaterno, apellidoMaterno) {
        document.getElementById('edit_id').value = id;
        document.getElementById('edit_correo').value = correo;
        document.getElementById('edit_colegio').value = colegioId;
        document.getElementById('edit_curso').value = curso;
        document.getElementById('edit_nombre').value = nombre || '';
        document.getElementById('edit_apellidoPaterno').value = apellidoPaterno || '';
        document.getElementById('edit_apellidoMaterno').value = apellidoMaterno || '';
        
        // Limpiar campo de contraseña al abrir el modal
        document.getElementById('edit_contrasenia').value = '';
        
        editModal.style.display = 'flex';
    }

    // Función para cerrar modal de editar estudiante
    function closeEditModal() {
        editModal.style.display = 'none';
        document.getElementById('editStudentForm').reset();
    }

    // Función para mostrar alertas
    function showAlert(message, type = 'success') {
        const config = {
            success: {
                title: 'Éxito',
                icon: 'fa-check-circle',
                className: 'alert-success'
            },
            error: {
                title: 'Error',
                icon: 'fa-exclamation-circle',
                className: 'alert-error'
            },
            warning: {
                title: 'Advertencia',
                icon: 'fa-exclamation-triangle',
                className: 'alert-warning'
            }
        };
        
        const { title, icon, className } = config[type];
        
        document.getElementById('alertTitle').textContent = title;
        document.getElementById('alertIcon').className = `fas ${icon} alert-icon`;
        document.getElementById('alertMessage').textContent = message;
        customAlert.className = `custom-alert ${className}`;
        customAlert.classList.add('show');
        
        setTimeout(() => {
            customAlert.classList.remove('show');
        }, 5000);
    }

    // Funcionalidad para mostrar/ocultar contraseña
    document.addEventListener('click', function(e) {
        if (e.target.closest('.toggle-password')) {
            const button = e.target.closest('.toggle-password');
            const targetId = button.getAttribute('data-target');
            const passwordInput = document.getElementById(targetId);
            const icon = button.querySelector('i');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                passwordInput.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }
    });

    // Event listeners para modales
    newStudentBtn.addEventListener('click', openModal);
    closeModalBtn.addEventListener('click', closeModal);
    closeEditModalBtn.addEventListener('click', closeEditModal);
    cancelBtn.addEventListener('click', closeModal);
    cancelEditBtn.addEventListener('click', closeEditModal);
    alertClose.addEventListener('click', () => customAlert.classList.remove('show'));

    // Funcionalidad de búsqueda
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = tableBody.getElementsByTagName('tr');
        let visibleCount = 0;
        
        clearSearch.style.display = searchTerm ? 'block' : 'none';
        
        for (let row of rows) {
            const text = row.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        }
        
        if (visibleCount === 0 && searchTerm) {
            if (!document.getElementById('noResults')) {
                const noResults = document.createElement('tr');
                noResults.id = 'noResults';
                noResults.innerHTML = `
                    <td colspan="6">
                        <div class="empty-state">
                            <i class="fas fa-search"></i>
                            <h3>No se encontraron resultados</h3>
                            <p>Intente con otros términos de búsqueda</p>
                        </div>
                    </td>
                `;
                tableBody.appendChild(noResults);
            }
        } else {
            const noResults = document.getElementById('noResults');
            if (noResults) noResults.remove();
        }
    });

    // Limpiar búsqueda
    clearSearch.addEventListener('click', () => {
        searchInput.value = '';
        clearSearch.style.display = 'none';
        const rows = tableBody.getElementsByTagName('tr');
        for (let row of rows) {
            row.style.display = '';
        }
        const noResults = document.getElementById('noResults');
        if (noResults) noResults.remove();
    });

    // Cerrar modales al hacer clic fuera
    window.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
        if (e.target === editModal) closeEditModal();
    });

    // Cerrar modales con tecla Escape
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            if (modal.style.display === 'flex') closeModal();
            if (editModal.style.display === 'flex') closeEditModal();
        }
    });

    // Toggle estado con bolita redonda
    document.querySelectorAll('.toggle-estado').forEach(sw => {
        sw.addEventListener('change', function(){
            const form = this.closest('.estado-form');
            const estudianteId = form.querySelector('input[name="estudiante_id"]').value;
            
            // Crear FormData para enviar el formulario
            const formData = new FormData(form);
            
            fetch('', {  // URL vacía para enviar a la misma vista
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => {
                if (response.ok) {
                    showAlert('Estado del estudiante actualizado correctamente', 'success');
                } else {
                    showAlert('Error al cambiar el estado', 'error');
                    // Revertir el cambio visual si falla
                    this.checked = !this.checked;
                }
            })
            .catch(err => {
                console.error('Error:', err);
                showAlert('Error al cambiar el estado', 'error');
                this.checked = !this.checked;
            });
        }); 
    });
</script>
{% endblock %}