{% extends 'administrador/base_admin.html' %}
{% load static %}
{% block title %}Bestion de Usuarios{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Usuarios</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #F3F3E0;
            color: #333;
            padding: 30px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            padding: 30px;
            position: relative;
        }
        
        /* Barra de ayuda */
        .help-bar {
            position: absolute;
            top: 30px;
            right: 30px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .search-input {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            width: 200px;
            transition: all 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #608BC1;
            box-shadow: 0 0 0 2px rgba(96, 139, 193, 0.2);
        }
        
        .help-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background-color: #133E87;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        .help-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(19, 62, 135, 0.3);
        }
        
        h1 {
            color: #133E87;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #CBDCEB;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-right: 250px;
        }
        
        h1 i {
            color: #608BC1;
        }
        
        h2 {
            color: #133E87;
            margin-bottom: 20px;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        h2 i {
            color: #608BC1;
        }
        
        /* Menú de gestión de usuarios */
        .user-management {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .user-management-item {
            padding: 10px 20px;
            background-color: #608BC1;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(96, 139, 193, 0.3);
        }
        
        .user-management-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(96, 139, 193, 0.4);
            background-color: #133E87;
        }
        
        /* Separador */
        .divider {
            height: 1px;
            background-color: #CBDCEB;
            margin: 20px 0;
        }
        
        /* Tabla de usuarios */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        th {
            background-color: #133E87;
            color: white;
            text-align: left;
            padding: 15px;
            font-weight: 600;
        }
        
        th:first-child {
            border-top-left-radius: 8px;
        }
        
        th:last-child {
            border-top-right-radius: 8px;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #CBDCEB;
            vertical-align: middle;
        }
        
        tr:hover {
            background-color: #F3F3E0;
        }
        
        /* Interruptor deslizante para estado */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e74c3c;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #27ae60;
        }
        
        input:checked + .slider:before {
            transform: translateX(30px);
        }
        
        .slider-text {
            margin-left: 70px;
            font-weight: 500;
            color: #333;
        }
        
        .status-active .slider-text {
            color: #27ae60;
        }
        
        .status-inactive .slider-text {
            color: #e74c3c;
        }
        
        .status-container {
            display: flex;
            align-items: center;
        }
        
        /* Acciones con más espacio */
        .actions {
            display: flex;
            gap: 8px;
            justify-content: flex-start;
        }
        
        .action-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
            flex-shrink: 0;
        }
        
        .action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .btn-edit {
            background-color: #608BC1;
        }
        
        .btn-edit:hover {
            background-color: #133E87;
        }
        
        .btn-delete {
            background-color: #e74c3c;
        }
        
        .btn-delete:hover {
            background-color: #c0392b;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateX(150%);
            transition: transform 0.4s ease;
            z-index: 1000;
            display: none;
        }
        
        .notification.show {
            display: block;
            transform: translateX(0);
        }
        
        .notification.success {
            background-color: #2ecc71;
        }
        
        .notification.error {
            background-color: #e74c3c;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .modal h3 {
            margin-bottom: 20px;
            color: #133E87;
            border-bottom: 1px solid #CBDCEB;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #133E87;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #CBDCEB;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-cancel {
            background-color: #95a5a6;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn-cancel:hover {
            background-color: #7f8c8d;
        }
        
        .btn-save {
            background-color: #608BC1;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn-save:hover {
            background-color: #133E87;
        }
        
        /* Panel de ayuda */
        .help-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 3000;
            width: 90%;
            max-width: 500px;
        }
        
        .help-panel h3 {
            color: #133E87;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .help-panel ul {
            list-style-type: none;
            margin-bottom: 20px;
        }
        
        .help-panel li {
            padding: 10px 0;
            border-bottom: 1px solid #CBDCEB;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .help-panel li i {
            color: #608BC1;
        }
        
        .close-help {
            background-color: #95a5a6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            float: right;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            
            .container {
                padding: 20px;
            }
            
            .help-bar {
                position: static;
                margin-bottom: 20px;
                justify-content: center;
                width: 100%;
            }
            
            h1 {
                padding-right: 0;
                text-align: center;
                justify-content: center;
            }
            
            .user-management {
                flex-direction: column;
            }
            
            table {
                display: block;
                overflow-x: auto;
            }
            
            .status-container {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .slider-text {
                margin-left: 0;
            }
            
            .actions {
                justify-content: center;
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Barra de ayuda -->
        <div class="help-bar">
            <input type="text" class="search-input" placeholder="Buscar usuarios...">
            <button class="help-btn" id="helpBtn">
                <i class="fas fa-question"></i>
            </button>
        </div>
        
        <h1><i class="fas fa-users"></i> GESTIÓN DE USUARIOS</h1>
        
        <h2><i class="fas fa-user-cog"></i> Gestión de Usuarios</h2>
        
        <div class="user-management">
            <div class="user-management-item" id="newUser">
                <i class="fas fa-plus"></i> Nuevo Usuario
            </div>
            <div class="user-management-item" id="searchBtn">
                <i class="fas fa-search"></i> Buscar
            </div>
        </div>
        
        <div class="divider"></div>
        
        <h2><i class="fas fa-user-check"></i> Usuarios Registrados</h2>
        
        <table>
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Correo</th>
                    <th>Tipo</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="usersTableBody">
                {% for usuario in usuarios %}
                <tr data-id="{{ usuario.id }}">
                    <td>{{ usuario.nombre }} {{ usuario.apellido }}</td>
                    <td>{{ usuario.correo }}</td>
                    <td>
                        {% if usuario.tipo == 'estudiante' %}Estudiante
                        {% elif usuario.tipo == 'universitario' %}Universitario
                        {% elif usuario.tipo == 'profesional' %}Profesional
                        {% else %}{{ usuario.tipo }}{% endif %}
                    </td>
                    <td>
                        <div class="status-container {% if usuario.activo %}status-active{% else %}status-inactive{% endif %}">
                            <label class="toggle-switch">
                                <input type="checkbox" class="status-toggle" 
                                       data-id="{{ usuario.id }}" 
                                       {% if usuario.activo %}checked{% endif %}>
                                <span class="slider"></span>
                            </label>
                            <span class="slider-text">
                                {% if usuario.activo %}Activo{% else %}Inactivo{% endif %}
                            </span>
                        </div>
                    </td>
                    <td class="actions">
                        <button class="action-btn btn-edit" data-id="{{ usuario.id }}" title="Editar">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                        <button class="action-btn btn-delete" data-id="{{ usuario.id }}" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="text-align: center; padding: 20px;">
                        No hay usuarios registrados
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Modal para editar/crear usuario -->
    <div class="modal" id="userModal">
        <div class="modal-content">
            <h3 id="modalTitle">Nuevo Usuario</h3>
            <form id="userForm" method="post">
                {% csrf_token %}
                <input type="hidden" id="userId" name="user_id">
                
                <div class="form-group">
                    <label for="userNombre">Nombre</label>
                    <input type="text" id="userNombre" name="nombre" placeholder="Ingrese el nombre" required>
                </div>
                
                <div class="form-group">
                    <label for="userApellido">Apellido</label>
                    <input type="text" id="userApellido" name="apellido" placeholder="Ingrese el apellido" required>
                </div>
                
                <div class="form-group">
                    <label for="userEmail">Correo Electrónico</label>
                    <input type="email" id="userEmail" name="correo" placeholder="Ingrese el correo electrónico" required>
                </div>
                
                <div class="form-group">
                    <label for="userType">Tipo de Usuario</label>
                    <select id="userType" name="tipo" required>
                        <option value="estudiante">Estudiante</option>
                        <option value="universitario">Universitario</option>
                        <option value="profesional">Profesional</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="userPassword">Contraseña</label>
                    <input type="password" id="userPassword" name="contrasena" placeholder="Ingrese la contraseña">
                    <small style="color: #666; font-size: 12px;">Para editar usuario, solo complete si desea cambiar la contraseña</small>
                </div>
                
                <div class="modal-buttons">
                    <button type="button" class="btn-cancel" id="cancelBtn">Cancelar</button>
                    <button type="submit" class="btn-save" id="saveBtn">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Panel de ayuda -->
    <div class="help-panel" id="helpPanel">
        <h3><i class="fas fa-question-circle"></i> Centro de Ayuda</h3>
        <ul>
            <li><i class="fas fa-plus"></i> <strong>Nuevo Usuario:</strong> Crear un nuevo usuario</li>
            <li><i class="fas fa-search"></i> <strong>Buscar:</strong> Buscar usuarios existentes</li>
            <li><i class="fas fa-pencil-alt"></i> <strong>Editar:</strong> Modificar un usuario existente</li>
            <li><i class="fas fa-trash"></i> <strong>Eliminar:</strong> Eliminar un usuario permanentemente</li>
            <li><i class="fas fa-toggle-on"></i> <strong>Interruptor:</strong> Deslizar para activar/desactivar usuario</li>
        </ul>
        <p>Para más ayuda, contacte al administrador del sistema.</p>
        <button class="close-help" id="closeHelp">Cerrar</button>
    </div>

    <!-- Notificación -->
    <div class="notification" id="notification"></div>

    <script>
    // Variables globales
let currentEditingUser = null;

// Elementos del DOM
const newUserButton = document.getElementById('newUser');
const modal = document.getElementById('userModal');
const modalTitle = document.getElementById('modalTitle');
const userForm = document.getElementById('userForm');
const userIdInput = document.getElementById('userId');
const userNombreInput = document.getElementById('userNombre');
const userApellidoInput = document.getElementById('userApellido');
const userEmailInput = document.getElementById('userEmail');
const userTypeSelect = document.getElementById('userType');
const userPasswordInput = document.getElementById('userPassword');
const cancelBtn = document.getElementById('cancelBtn');
const saveBtn = document.getElementById('saveBtn');
const notification = document.getElementById('notification');
const helpBtn = document.getElementById('helpBtn');
const helpPanel = document.getElementById('helpPanel');
const closeHelp = document.getElementById('closeHelp');
const searchInput = document.querySelector('.search-input');
const searchBtn = document.getElementById('searchBtn');

// Obtener el token CSRF
function getCSRFToken() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    return csrfToken ? csrfToken.value : '';
}

// Funciones de utilidad
function showNotification(message, type) {
    notification.textContent = message;
    notification.className = `notification ${type}`;
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 4000);
}

function openModal(isNew = false, userData = null) {
    if (isNew) {
        modalTitle.textContent = 'Nuevo Usuario';
        userIdInput.value = '';
        userNombreInput.value = '';
        userApellidoInput.value = '';
        userEmailInput.value = '';
        userTypeSelect.value = 'estudiante';
        userPasswordInput.value = '';
        userPasswordInput.required = true;
        userPasswordInput.placeholder = 'Ingrese la contraseña';
        currentEditingUser = null;
    } else {
        modalTitle.textContent = 'Editar Usuario';
        userIdInput.value = userData.id;
        userNombreInput.value = userData.nombre;
        userApellidoInput.value = userData.apellido;
        userEmailInput.value = userData.correo;
        userTypeSelect.value = userData.tipo;
        userPasswordInput.value = '';
        userPasswordInput.required = false;
        userPasswordInput.placeholder = 'Dejar vacío para mantener contraseña actual';
    }
    modal.style.display = 'flex';
}

function closeModal() {
    modal.style.display = 'none';
    userForm.reset();
}

// Event Listeners
newUserButton.addEventListener('click', () => {
    openModal(true);
});

// Agregar event listeners a los botones de edición
document.addEventListener('click', function(e) {
    if (e.target.closest('.btn-edit')) {
        const button = e.target.closest('.btn-edit');
        const userId = button.getAttribute('data-id');
        const userRow = button.closest('tr');
        
        // Obtener datos del usuario desde la fila
        const cells = userRow.querySelectorAll('td');
        const nombreCompleto = cells[0].textContent.trim().split(' ');
        
        const userData = {
            id: userId,
            nombre: nombreCompleto[0] || '',
            apellido: nombreCompleto.slice(1).join(' ') || '',
            correo: cells[1].textContent.trim(),
            tipo: cells[2].textContent.trim().toLowerCase()
        };
        
        // Convertir tipo a valor del select
        if (userData.tipo.includes('estudiante')) userData.tipo = 'estudiante';
        else if (userData.tipo.includes('universitario')) userData.tipo = 'universitario';
        else if (userData.tipo.includes('profesional')) userData.tipo = 'profesional';
        
        console.log('Datos para editar:', userData); // Debug
        
        currentEditingUser = userRow;
        openModal(false, userData);
    }
});

// Agregar event listeners a los botones de eliminación
document.addEventListener('click', function(e) {
    if (e.target.closest('.btn-delete')) {
        const button = e.target.closest('.btn-delete');
        const userId = button.getAttribute('data-id');
        const userRow = button.closest('tr');
        const userName = userRow.cells[0].textContent;
        
        if (confirm(`¿Está seguro de que desea eliminar al usuario "${userName}"?`)) {
            // Crear FormData para enviar
            const formData = new FormData();
            formData.append('action', 'eliminar');
            formData.append('id', userId);
            formData.append('csrfmiddlewaretoken', getCSRFToken());
            
            // Enviar solicitud de eliminación al servidor
            fetch('', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    userRow.style.opacity = '0.5';
                    userRow.style.transition = 'opacity 0.3s';
                    
                    setTimeout(() => {
                        userRow.remove();
                        showNotification(data.message, 'success');
                    }, 500);
                } else {
                    showNotification('Error al eliminar: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error al eliminar el usuario', 'error');
            });
        }
    }
});

cancelBtn.addEventListener('click', closeModal);

// MANEJAR EL ENVÍO DEL FORMULARIO - VERSIÓN CORREGIDA
userForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const userId = userIdInput.value;
    const isNew = !userId;
    
    console.log('Enviando formulario:', { 
        isNew, 
        userId, 
        nombre: userNombreInput.value,
        apellido: userApellidoInput.value,
        correo: userEmailInput.value,
        tipo: userTypeSelect.value
    });

    // Validación básica
    if (isNew && !userPasswordInput.value) {
        showNotification('La contraseña es obligatoria para nuevos usuarios', 'error');
        return;
    }

    // Mostrar loading en el botón
    const originalText = saveBtn.textContent;
    saveBtn.textContent = 'Guardando...';
    saveBtn.disabled = true;

    // Crear FormData para enviar
    const formData = new FormData();
    formData.append('action', isNew ? 'crear' : 'editar');
    formData.append('nombre', userNombreInput.value.trim());
    formData.append('apellido', userApellidoInput.value.trim());
    formData.append('correo', userEmailInput.value.trim());
    formData.append('tipo', userTypeSelect.value);
    formData.append('csrfmiddlewaretoken', getCSRFToken());
    
    if (userPasswordInput.value) {
        formData.append('contrasena', userPasswordInput.value);
    }
    
    if (!isNew) {
        formData.append('user_id', userId);
    }

    // Enviar con fetch
    fetch('', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Error en la respuesta del servidor');
        }
        return response.json();
    })
    .then(data => {
        console.log('Respuesta del servidor:', data); // Debug
        
        if (data.success) {
            showNotification(data.message, 'success');
            closeModal();
            // Recargar la página después de un tiempo
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showNotification('Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error en fetch:', error);
        showNotification('Error de conexión: ' + error.message, 'error');
    })
    .finally(() => {
        // Restaurar botón
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
    });
});

// Funcionalidad de búsqueda
searchBtn.addEventListener('click', () => {
    const searchText = searchInput.value.trim();
    if (searchText) {
        // Filtrar filas de la tabla
        const rows = document.querySelectorAll('#usersTableBody tr');
        let found = false;
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            if (text.includes(searchText.toLowerCase())) {
                row.style.display = '';
                found = true;
            } else {
                row.style.display = 'none';
            }
        });
        
        if (found) {
            showNotification(`Mostrando resultados para: "${searchText}"`, 'success');
        } else {
            showNotification(`No se encontraron resultados para: "${searchText}"`, 'error');
        }
    } else {
        // Mostrar todas las filas
        const rows = document.querySelectorAll('#usersTableBody tr');
        rows.forEach(row => {
            row.style.display = '';
        });
        showNotification('Mostrando todos los usuarios', 'success');
    }
});

searchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        searchBtn.click();
    }
});

// Funcionalidad de la barra de ayuda
helpBtn.addEventListener('click', () => {
    helpPanel.style.display = 'block';
});

closeHelp.addEventListener('click', () => {
    helpPanel.style.display = 'none';
});

// Cerrar modales al hacer clic fuera del contenido
window.addEventListener('click', (event) => {
    if (event.target === modal) {
        closeModal();
    }
    if (event.target === helpPanel) {
        helpPanel.style.display = 'none';
    }
});

console.log('Script de gestión de usuarios cargado correctamente');
    </script>
</body>
</html>
{% endblock %}