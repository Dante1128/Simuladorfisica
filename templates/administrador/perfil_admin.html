{% extends 'administrador/base_admin.html' %}
{% load static %}
{% block title %}Perfil de administrador{% endblock %}

{% block content %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/administrador/perfil_admin.css' %}">        
    
    <!-- Contenido Principal -->
    <main class="main-content">
        <div class="profile-container">
            <!-- Mensajes -->
            <div id="successMessage" class="message success">
                <i class="fas fa-check-circle"></i> <span>Los cambios se han guardado correctamente.</span>
            </div>
            
            <div id="errorMessage" class="message error">
                <i class="fas fa-exclamation-circle"></i> <span>Ha ocurrido un error. Por favor, inténtalo de nuevo.</span>
            </div>

            <!-- Encabezado del Perfil -->
            <div class="profile-header">
                <div class="profile-avatar">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="profile-info">
                    <h1 id="profileName">{{ administrador.nombre }} {{ administrador.apellido }}</h1>
                    <span class="admin-badge">Administrador Académico</span>
                    <div class="contact-info">
                        <p><i class="fas fa-envelope"></i> {{ administrador.email }}</p>
                        <p><i class="fas fa-school"></i> {{ administrador.colegio.nombre }}</p>
                    </div>
                    
                    <div class="profile-stats">
                        <div class="stat-item">
                            <div class="stat-icon">
                                <i class="fas fa-chalkboard-teacher"></i>
                            </div>
                            <div class="stat-content">
                                <span class="stat-value">{{ estadisticas.docentes }}</span>
                                <span class="stat-label">Docentes</span>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                            <div class="stat-content">
                                <span class="stat-value">{{ estadisticas.estudiantes }}</span>
                                <span class="stat-label">Estudiantes</span>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon">
                                <i class="fas fa-book"></i>
                            </div>
                            <div class="stat-content">
                                <span class="stat-value">{{ estadisticas.cursos }}</span>
                                <span class="stat-label">Cursos</span>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon">
                                <i class="fas fa-flask"></i>
                            </div>
                            <div class="stat-content">
                                <span class="stat-value">{{ estadisticas.laboratorios }}</span>
                                <span class="stat-label">Laboratorios</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenido del Perfil -->
            <div class="profile-content">
                <!-- Información Personal -->
                <div class="profile-card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-user"></i>
                            Información Personal
                        </h2>
                        <button class="btn-edit" onclick="toggleEdit('personalInfo')">
                            <i class="fas fa-edit"></i>
                            Editar
                        </button>
                    </div>
                    
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">
                                <i class="fas fa-id-card"></i>
                                Nombre Completo
                            </span>
                            <span class="info-value editable" onclick="editField('nombre')" id="nombreValue">
                                {{ administrador.nombre }} {{ administrador.apellido }}
                            </span>
                        </div>
                        
                        <div class="info-item">
                            <span class="info-label">
                                <i class="fas fa-envelope"></i>
                                Correo Electrónico
                            </span>
                            <span class="info-value editable" onclick="editField('email')" id="emailValue">
                                {{ administrador.email }}
                            </span>
                        </div>
                        
                        <div class="info-item">
                            <span class="info-label">
                                <i class="fas fa-phone"></i>
                                Teléfono
                            </span>
                            <span class="info-value editable" onclick="editField('telefono')" id="telefonoValue">
                                {{ administrador.telefono|default:"No especificado" }}
                            </span>
                        </div>
                        
                        <div class="info-item">
                            <span class="info-label">
                                <i class="fas fa-calendar"></i>
                                Fecha de Registro
                            </span>
                            <span class="info-value">
                                {{ administrador.fecha_registro|date:"d/m/Y" }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Información del Colegio -->
                <div class="profile-card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-school"></i>
                            Información del Colegio
                        </h2>
                    </div>
                    
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">
                                <i class="fas fa-university"></i>
                                Nombre del Colegio
                            </span>
                            <span class="info-value">
                                {{ administrador.colegio.nombre }}
                            </span>
                        </div>
                        
                        <div class="info-item">
                            <span class="info-label">
                                <i class="fas fa-map-marker-alt"></i>
                                Dirección
                            </span>
                            <span class="info-value">
                                {{ administrador.colegio.direccion }}
                            </span>
                        </div>
                        
                        <div class="info-item">
                            <span class="info-label">
                                <i class="fas fa-phone"></i>
                                Teléfono del Colegio
                            </span>
                            <span class="info-value">
                                {{ administrador.colegio.telefono }}
                            </span>
                        </div>
                        
                        <div class="info-item">
                            <span class="info-label">
                                <i class="fas fa-globe"></i>
                                Sitio Web
                            </span>
                            <span class="info-value">
                                {{ administrador.colegio.sitio_web|default:"No especificado" }}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Configuración de Cuenta -->
                <div class="profile-card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-cog"></i>
                            Configuración de Cuenta
                        </h2>
                    </div>
                    
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">
                                <i class="fas fa-shield-alt"></i>
                                Estado de la Cuenta
                            </span>
                            <span class="info-value">
                                <span class="status-active">
                                    <i class="fas fa-check-circle"></i> Activa
                                </span>
                            </span>
                        </div>
                        
                        <div class="info-item">
                            <span class="info-label">
                                <i class="fas fa-key"></i>
                                Cambiar Contraseña
                            </span>
                            <span class="info-value">
                                <button class="btn-edit" onclick="showPasswordModal()">
                                    <i class="fas fa-lock"></i>
                                    Cambiar
                                </button>
                            </span>
                        </div>
                        
                        <div class="info-item">
                            <span class="info-label">
                                <i class="fas fa-bell"></i>
                                Notificaciones
                            </span>
                            <span class="info-value">
                                <label class="switch">
                                    <input type="checkbox" checked>
                                    <span class="slider"></span>
                                </label>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Actividad Reciente -->
                <div class="profile-card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-history"></i>
                            Actividad Reciente
                        </h2>
                    </div>
                    
                    <div class="activity-list">
                        {% for actividad in actividades %}
                        <div class="activity-item">
                            <div class="activity-icon">
                                <i class="fas fa-{{ actividad.icono }}"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">{{ actividad.titulo }}</div>
                                <div class="activity-description">{{ actividad.descripcion }}</div>
                                <div class="activity-time">
                                    <i class="fas fa-clock"></i> {{ actividad.fecha|timesince }} ago
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="activity-item">
                            <div class="activity-content">
                                <div class="activity-title">No hay actividad reciente</div>
                                <div class="activity-description">Tu actividad aparecerá aquí</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal para Cambiar Contraseña -->
    <div class="modal-overlay" id="passwordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-lock"></i> Cambiar Contraseña</h3>
                <button class="close-modal" id="closePasswordModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="passwordForm">
                    <div class="form-group">
                        <label for="currentPassword">Contraseña Actual</label>
                        <input type="password" id="currentPassword" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="newPassword">Nueva Contraseña</label>
                        <input type="password" id="newPassword" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirmPassword">Confirmar Nueva Contraseña</label>
                        <input type="password" id="confirmPassword" class="form-control" required>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn-cancel" onclick="closePasswordModal()">Cancelar</button>
                        <button type="submit" class="btn-save">Cambiar Contraseña</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Funciones para la edición del perfil
        function toggleEdit(section) {
            const editForms = document.querySelectorAll('.edit-form');
            editForms.forEach(form => {
                if (form.id === section + 'Form') {
                    form.style.display = form.style.display === 'block' ? 'none' : 'block';
                } else {
                    form.style.display = 'none';
                }
            });
        }

        function editField(field) {
            const valueElement = document.getElementById(field + 'Value');
            const currentValue = valueElement.textContent.trim();
            
            // Crear formulario de edición
            const form = document.createElement('div');
            form.className = 'edit-form';
            form.innerHTML = `
                <div class="form-group">
                    <input type="text" class="form-control" value="${currentValue}" id="${field}Input">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="cancelEdit('${field}')">Cancelar</button>
                    <button type="button" class="btn-save" onclick="saveField('${field}')">Guardar</button>
                </div>
            `;
            
            valueElement.parentNode.appendChild(form);
            valueElement.style.display = 'none';
            document.getElementById(field + 'Input').focus();
        }

        function saveField(field) {
            const input = document.getElementById(field + 'Input');
            const newValue = input.value;
            const valueElement = document.getElementById(field + 'Value');
            
            // Simular guardado en base de datos
            fetch(`/api/administrador/actualizar/${field}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    value: newValue
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    valueElement.textContent = newValue;
                    showMessage('success', 'Campo actualizado correctamente');
                    
                    // Actualizar nombre en el header si es el campo nombre
                    if (field === 'nombre') {
                        document.getElementById('profileName').textContent = newValue;
                    }
                } else {
                    showMessage('error', 'Error al actualizar el campo');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('error', 'Error de conexión');
            });
            
            // Limpiar formulario
            const form = input.closest('.edit-form');
            form.remove();
            valueElement.style.display = 'block';
        }

        function cancelEdit(field) {
            const valueElement = document.getElementById(field + 'Value');
            const form = valueElement.nextElementSibling;
            
            form.remove();
            valueElement.style.display = 'block';
        }

        // Funciones para el modal de contraseña
        function showPasswordModal() {
            document.getElementById('passwordModal').style.display = 'flex';
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('passwordForm').reset();
        }

        // Manejar envío del formulario de contraseña
        document.getElementById('passwordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                showMessage('error', 'Las contraseñas no coinciden');
                return;
            }
            
            // Simular cambio de contraseña
            fetch('/api/administrador/cambiar-password/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    current_password: currentPassword,
                    new_password: newPassword
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('success', 'Contraseña cambiada correctamente');
                    closePasswordModal();
                } else {
                    showMessage('error', data.message || 'Error al cambiar la contraseña');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('error', 'Error de conexión');
            });
        });

        // Funciones auxiliares
        function showMessage(type, text) {
            const messageElement = document.getElementById(type + 'Message');
            messageElement.querySelector('span').textContent = text;
            messageElement.style.display = 'flex';
            
            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 5000);
        }

        function getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]').value;
        }

        // Cerrar modales al hacer clic fuera
        window.addEventListener('click', function(e) {
            if (e.target === document.getElementById('passwordModal')) {
                closePasswordModal();
            }
        });

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Perfil de Administrador cargado');
            
            // Cerrar modal con ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closePasswordModal();
                }
            });
            
            // Cerrar modal con botón X
            document.getElementById('closePasswordModal').addEventListener('click', closePasswordModal);
        });
    </script>
{% endblock %}